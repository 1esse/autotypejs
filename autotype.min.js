"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var s=0,n=function(){};return{s:n,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){a=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,s=new Array(t);r<t;r++)s[r]=e[r];return s}var AutoType=function(){function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if((0,_classCallCheck2.default)(this,r),this.task_queue=[],this.type_content="",this.history_stack=[],this._task_queue=[],this._task_count=0,this.doneAction=null,this.config(t),"string"!=typeof e)throw TypeError("请传入正确的dom节点选择器");this.dom=document.querySelector(e)}var e;return(0,_createClass2.default)(r,[{key:"config",value:function(e){var t=e.cursor_typing,r=void 0===t?"cursor_typing":t,s=e.cursor_stay,n=void 0===s?"cursor_stay":s,o=e.loop,i=void 0!==o&&o,a=e.show_cursor,u=void 0===a||a,c=e.show_end_cursor,h=void 0===c||c;this.cursor_typing=r,this.cursor_stay=n,this.loop=i,this.show_cursor=u,this.show_end_cursor=h}},{key:"setStage",value:function(e){var t=e.media,r=void 0===t?"text":t,s=e.text,n=void 0===s?"":s,o=e.duration,i=void 0===o?0:o,a=e.type,u=void 0===a?"add":a,c=e.delete_count,h=void 0===c?0:c,l=e.src,_=void 0===l?"":l,d=e.line_wrap,y=void 0!==d&&d,p=e.style,f=void 0===p?"":p;if(f instanceof Object){for(var v="",k=0,b=Object.entries(f);k<b.length;k++){var m=(0,_slicedToArray2.default)(b[k],2),g=m[0],x=m[1];v+="".concat(g,": ").concat(x,";")}f=v}var q={media:r,text:n,duration:i,type:u,delete_count:parseInt(h),src:_,line_wrap:y,style:f};return this.task_queue.push(q),this._task_count++,this}},{key:"runTask",value:(e=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(){var t,r,s,n,o,i,a,u;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.task_queue.shift()){e.next=3;break}throw Error("执行任务失败，空任务");case 3:e.t0=t.type,e.next="add"===e.t0?6:"delete"===e.t0?42:56;break;case 6:if(t.line_wrap&&(this.type_content+="<br>",this._render(this.type_content)),"text"!==t.media){e.next=36;break}if(r=Math.floor(t.duration/(t.text.length||1)),e.t1=0===t.text.length,e.t1)return e.next=13,this._sleep(r);e.next=13;break;case 13:s="",n=_createForOfIteratorHelper(t.text),e.prev=15,n.s();case 17:if((o=n.n()).done){e.next=25;break}return i=o.value,e.next=21,this._sleep(r);case 21:s+=i,this._render("".concat(this.type_content,'<span style="').concat(t.style,'">').concat(s,"</span>"));case 23:e.next=17;break;case 25:e.next=30;break;case 27:e.prev=27,e.t2=e.catch(15),n.e(e.t2);case 30:return e.prev=30,n.f(),e.finish(30);case 33:this.type_content+='<span style="'.concat(t.style,'">').concat(t.text,"</span>"),e.next=41;break;case 36:if("image"===t.media)return e.next=39,this._sleep(t.duration);e.next=41;break;case 39:this.type_content+='<img style="'.concat(t.style,'" src=').concat(t.src," >"),this._render(this.type_content);case 41:return e.abrupt("break",56);case 42:t.delete_count>this.history_stack.length&&(t.delete_count=this.history_stack.length),a=Math.floor(t.duration/(t.delete_count||1)),0===t.delete_count&&this._sleep(a),u=0;case 46:if(u<t.delete_count)return e.next=49,this._sleep(a);e.next=55;break;case 49:this.history_stack.pop(),this.type_content=this.history_stack[this.history_stack.length-1]||"",this._render(this.type_content,!1);case 52:u++,e.next=46;break;case 55:return e.abrupt("break",56);case 56:this._task_queue.push(t),0<this.task_queue.length&&this.runTask(),this._task_queue.length===this._task_count&&(this.history_stack=[],this.show_cursor&&(this.dom.classList.remove(this.cursor_typing),this.show_end_cursor?this.dom.classList.add(this.cursor_stay):this.dom.classList.remove(this.cursor_stay)),this.loop&&(this.type_content="",this.task_queue=this._task_queue,this._task_queue=[],this.runTask()),this.doneAction&&this.doneAction());case 59:case"end":return e.stop()}},e,this,[[15,27,30,33]])})),function(){return e.apply(this,arguments)})},{key:"onceDone",value:function(e){var t=0<arguments.length&&void 0!==e?e:null;t&&(this.doneAction=t)}},{key:"_render",value:function(e,t){var r=!(1<arguments.length&&void 0!==t)||t;this.show_cursor&&(this.dom.classList.remove(this.cursor_stay),this.dom.classList.add(this.cursor_typing)),this.dom.innerHTML=e,r&&this.history_stack.push(e)}},{key:"_sleep",value:function(r){return this.show_cursor&&1e3<=r&&(this.dom.classList.remove(this.cursor_typing),this.dom.classList.add(this.cursor_stay)),new Promise(function(e,t){setTimeout(function(){e()},r)})}}]),r}();module.exports=AutoType;